---
title: "Andersen Lab Strains"
author: "Dan Cook"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: yes
    theme: cosmo
    toc: yes
  pdf_document: 
    toc: yes
---


```{r, echo = F, warning=FALSE, message=FALSE}
library(readr)
library(tidyr)
library(dplyr)
library(knitr)
library(ggplot2)
library(scales)
library(gdata)

seqs <- readr::read_tsv("raw/seq.raw.tsv", na = c("","NA","#N/A"))

na_to_0 <- function(x) {
  ifelse(is.na(x), 0, x)
}

summarize_column <- function(colnames) {
       seqs %>%
       dplyr::filter(processed == TRUE) %>%
       dplyr::group_by_(.dots = colnames, "use_in_analysis") %>%
       dplyr::summarize(sum = n()) %>% 
       dplyr::ungroup() %>%
       tidyr::spread(use_in_analysis, sum) %>%
       dplyr::rename("YES" = `TRUE`, "NO" = `FALSE`) %>%
       dplyr::mutate_each(funs(na_to_0), everything()) %>%
       dplyr::mutate(use_rate = YES / (NO + YES))
}

run_count <- summarize_column("run")
lib_count <- summarize_column(c("run","lib"))
strain_count <- summarize_column(c("run","lib","strain","isotype"))

total_strains <- (strain_count %>%
                 dplyr::filter(use_rate > 0) %>%
                 dplyr::distinct(strain) %>%
                 dplyr::ungroup() %>%
                 dplyr::summarize(n = n()))$n

total_isotypes <- (strain_count %>%
                 dplyr::filter(use_rate > 0) %>%
                 dplyr::distinct(isotype) %>%
                 dplyr::ungroup() %>%
                 dplyr::summarize(n = n()))$n

total_sequences <- (dplyr::filter(seqs, use_in_analysis == TRUE) %>%
                   dplyr::summarize(n_reads = comma(sum(reads))))$n_reads

total_fastq_pairs <- nrow(dplyr::filter(seqs, use_in_analysis == TRUE))

total_file_size <- dplyr::filter(seqs, use_in_analysis == TRUE) %>%
                    dplyr::mutate(filesize = fq1_size + fq2_size) %>% 
                    dplyr::summarize(humanReadable(sum(as.numeric(filesize))))
        

libraries <- dplyr::group_by(seqs, lib) %>% summarize(sum = n())

```

#### Statistics

* __Total Strains__: `r total_strains`
* __Total Isotypes__: `r total_isotypes`
* __Total Sequences__: `r total_sequences`
* __Total Fastq Pairs__: `r total_fastq_pairs`
* __Total File Size__: `r total_file_size`

#### Runs

`r kable(run_count)`

#### Libraries

`r kable(lib_count)`

#### Strains

`r kable(strain_count)`


```{r generate isotype file, echo = F}

# Output clean seqs file
analysis_seqs <- dplyr::filter(seqs, use_in_analysis == T) %>%
                 dplyr::arrange(run, lib, isotype, strain)
readr::write_tsv(analysis_seqs, "processed/seqs.tsv")

isotype_set <- seqs %>% 
  dplyr::select(isotype, strain) %>%
  dplyr::filter(!is.na(isotype)) %>%
  dplyr::distinct() %>%
  dplyr::arrange(isotype)

readr::write_tsv(isotype_set, "processed/isotypes.tsv")

```